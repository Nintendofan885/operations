#   -------------------------------------------------------------
#   Configuration for Docker PaaS front-end nginx
#   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#   Author:         SÃ©bastien Santoro aka Dereckson
#   Created:        2020-02-18
#   Source file:    roles/paas-docker/nginx/files/nginx.conf
#   -------------------------------------------------------------
#
#   <auto-generated>
#       This file is managed by our rOPS SaltStack repository.
#
#       Changes to this file may cause incorrect behavior
#       and will be lost if the state is redeployed.
#   </auto-generated>

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections  1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;

    # Optimizing how packets are sent
    # Reference: https://thoughts.t37.net/nginx-optimization-understanding-sendfile-tcp-nodelay-and-tcp-nopush-c55cdd276765
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;

    keepalive_timeout   65;
    types_hash_max_size 2048;
    client_max_body_size 64M;
    server_names_hash_bucket_size 128;

    include       mime.types;
    default_type  application/octet-stream;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Base
    include /etc/nginx/vhosts/000-fallback.conf;
    include /etc/nginx/vhosts/001-server.conf;

    # Services hosted in containers
    include /etc/nginx/vhosts/*/*.conf;
}
